<!doctype html>
<html lang="en">

<head>
    <!--
      Idea and original implementation by Sacha Jerabek(jerabek.alexander_j at uqam.ca)

      This will display 3 columns
        - PNX record
        - Original record (this is probably a MarcXML record)
        - A formated MarcXML display

      If you want to be able to retrieve the Original Record(MarcXML) then you need to uncomment or add

            <mapping resource="com/exlibris/primo/domain/entities/OriginalSourceRecord.hbm.xml"/>

      to the hibernate mapping file /exlibris/primo/p4_1/ng/primo/home/system/search/conf/hibernate.cfg.xml
      The hibernate mapping file will be overwritten after each update this means you need to reapply this patch after every Primo upgrade.
      If you are hosted ask Ex Libris to enable it.


      contributors: Jerabek, Alexander J. <jerabek.alexander_j at uqam.ca>
                    Ulrich Leodolter <ulrich.leodolter at obvsg.at>
                    Mehmet Celik <mehmet.celik at libis.kuleuven.be>


      To use this you need to upload this file using the file uploader on the backend.
      TEMPLATE URL :
          http://YOUR.PRIMO.DOMAIN/primo_library/libweb/uploaded_files/YOUR.VIEW/libriansWB.html#YOUR.RECORD.ID
      EXAMPLE URL :
          http://limo.q.libis.be/primo_library/libweb/uploaded_files/IMAGES/librariansWB.html#32LIBIS_ALMA_DS71138579270001471


http://dakar.bib.uqam.ca/X?op=publish_avail&library=UQM01&doc_num=000974109
var alephXmlData = $('.alephxmldata')[0];
var remoteXML = alephXmlData.contentWindow?: alephXmlData.contentWindow ? alephXmlData.contentDocument.defaultView;
var xslMarc = jQuery.parseXML($('#pretty_marc').html()); //parse xslt document
var xsltProcessor = new XSLTProcessor();
xsltProcessor.importStylesheet(xslMarc);
var marc = xsltProcessor.transformToFragment(remoteXML, document); //transform ILS record
$('#data').append(marc);
    -->
    <meta charset="UTF-8">
    <title>Librarians Workbench</title>
    <script type='text/javascript' src='/primo_library/libweb/javascript/jquery/jquery-1.8.3.min.js'></script>
    <script type='text/javascript' src='/primo_library/libweb/javascript/jQuery.PRIMO.min.js'></script>

    <style type="text/css">
        body {
            font-family: "Consolas", Courier, monospace;
            padding: 0;
            margin: 0;
        }

        tbody {
            display: block;
            margin: 2em;
            position: absolute;
            top: 120px;
            right: 0;
            width: 30%;
            height: 650px;
            overflow: auto;
            border: 1px solid #ccc;
        }

        th {
            padding: .4em;
            border: 1px solid #ddd;
            background: #eee;
        }

        td {
            white-space: pre-wrap;
            padding: .4em;
            border: 1px solid #ddd;
        }

        strong {
            padding: 0 .4em 0 0;
            font-weight: normal;
        }

        iframe.pnxdata {
            margin: 2em;
            position: absolute;
            top: 120px;
            left: 0;
            width: 32%;
            height: 650px;
        }

        iframe.xmldata {
            margin: 2em;
            position: absolute;
            top: 120px;
            left: 33%;
            width: 32%;
            height: 650px;
        }

        h1 {
            text-align: center;
            padding: .2em;
            background: #eee;
            margin: 0;
        }

        h2 {
            text-align: center;
            padding: .4em;
            background: #eee;
            margin: 0;
            border-bottom: 1px solid #ccc;
        }
        #ilsdata {
            display:none;
        }
    </style>

    <!-- Template used to display the workbench -->
    <script type="text/template" id="libWB-tpl">
        <div>
            <h1>Record : {{ recordId }}</h1>
            <h2>PNX | Source XML | MARC</h2>

            <div>
                <iframe class="pnxdata" src='/primo_library/libweb/jqp/record/{{ recordId }}.pnx'></iframe>
                <iframe class="xmldata" src='/primo_library/libweb/jqp/record/{{ recordId }}.xml'></iframe>
                <iframe id="ilsdata" src='{{ ilsurl }}'></iframe>
                <div id='data'></div>
            </div>
        </div>
    </script>

    <!-- Template to display error remote record  -->
    <script type="text/template" id="remoteRecord-tpl">
        <table>
            <tbody>
                <tr>
                    <td>
                        <h1>Remote Record</h1>
                    </td>
                </tr>
            </tbody>
        </table>
    </script>

    <script type="text/template" id="noRecordID-tpl">
        <div>
            <h1>Please supply a record id</h1>
        </div>
    </script>

    <!-- XSLT to transform a MarcXML record into HTML -->
    <script type="text/xsl" id="pretty_marc">
        <xsl:stylesheet version="1.0" xmlns:marc="http://www.loc.gov/MARC21/slim" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
            <xsl:output method="html" />
            <xsl:template match="node()|@*">
                <xsl:apply-templates select="node()|@*" />
            </xsl:template>
            <xsl:template match="marc:record">
                <table>
                    <tr>
                        <th nowrap="true" align="right" valign="top">
                            000
                        </th>
                        <td colspan="2">
                            <xsl:value-of select="marc:leader" />
                        </td>
                    </tr>
                    <xsl:apply-templates select="marc:datafield|marc:controlfield" />
                </table>
            </xsl:template>
            <xsl:template match="marc:controlfield">
                <tr>
                    <th nowrap="true" align="right" valign="top">
                        <xsl:value-of select="@tag" />
                    </th>
                    <td class="controlfield" colspan="2">
                        <xsl:value-of select="." />
                    </td>
                </tr>
            </xsl:template>
            <xsl:template match="marc:datafield">
                <tr>
                    <th nowrap="true" align="right" valign="top">
                        <xsl:value-of select="@tag" />
                    </th>
                    <td>
                        <xsl:value-of select="@ind1" />
                        <xsl:value-of select="@ind2" />
                    </td>
                    <td>
                        <xsl:apply-templates select="marc:subfield" />
                    </td>
                </tr>
            </xsl:template>
            <xsl:template match="marc:subfield">
                <strong>|<xsl:value-of select="@code"/></strong>
                <xsl:value-of select="." />
            </xsl:template>
        </xsl:stylesheet>
    </script>

    <!-- XSLT to transform a MABXML record into HTML -->
    <script type="text/xsl" id="pretty_mab">
        <xsl:stylesheet version="1.0" xmlns:mab="http://www.ddb.de/professionell/mabxml/mabxml-1.xsd" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
            <xsl:output method="html" />
            <xsl:template match="node()|@*">
                <xsl:apply-templates select="node()|@*" />
            </xsl:template>
            <xsl:template match="mab:record">
                <table>
                    <tr>
                        <th nowrap="true" align="right" valign="top">
                            000
                        </th>
                        <td colspan="2">
                            <xsl:value-of select="mab:leader" />
                        </td>
                    </tr>
                    <xsl:apply-templates select="mab:datafield|mab:controlfield" />
                </table>
            </xsl:template>
            <xsl:template match="mab:controlfield">
                <tr>
                    <th nowrap="true" align="right" valign="top">
                        <xsl:value-of select="@tag" />
                    </th>
                    <td class="controlfield" colspan="2">
                        <xsl:value-of select="." />
                    </td>
                </tr>
            </xsl:template>
            <xsl:template match="mab:datafield">
                <tr>
                    <th nowrap="true" align="right" valign="top">
                        <xsl:value-of select="@tag" />
                    </th>
                    <td>
                        <xsl:value-of select="@ind1" />
                        <xsl:value-of select="@ind2" />
                    </td>
                    <td>
                        <xsl:apply-templates select="mab:subfield" />
                    </td>
                </tr>
            </xsl:template>
            <xsl:template match="mab:subfield">
                <strong>|<xsl:value-of select="@code"/></strong>
                <xsl:value-of select="." />
            </xsl:template>
        </xsl:stylesheet>
    </script>

</head>

<body>
    <!-- placeholder for MarcXML file before transformation -->
    <script type="application/xml" id='xml'></script>

    <script type="application/javascript">
        // get record id from URL
        var recordId = window.location.hash.substr(1);

        // setup ajax defaults
        $.ajaxSetup({
            header: { 'Accept-Encoding:': 'gzip,deflate' }
        });


        function convertXML2HTML(xmlId, xsltId) {
            var xml = jQuery.parseXML($(xmlId).html()); //parse xml document
            var xslMarc = jQuery.parseXML($(xsltId).html()); //parse xslt document
            var xsltProcessor = new XSLTProcessor();
            xsltProcessor.importStylesheet(xslMarc);
            var marc = xsltProcessor.transformToFragment(xml, document); //transform ILS record

            return marc;
        }

        //If we have a record id
        // 1) get record as JSON
        // 2) get record as XML
        // 3) render template libWB-tpl
        // 4) render ILS record in a table
        if (recordId && recordId.length > 0) {
            //GET record as an object
            $.getJSON('/primo_library/libweb/jqp/record/' + recordId + '.json', function(record) {
                //LOAD SOURCE XML data into #xml script tag. Must be enabled see https://github.com/mehmetc/jQuery.PRIMO#install-and-setup
                $('#xml').load('/primo_library/libweb/jqp/record/' + recordId + '.xml', function() {
                    var ilsRecordId = record.control.sourcerecordid; // get ILS record id

                    //Render template
                    $('body').append(jQuery.PRIMO.template.renderById("libWB-tpl", {
                        recordId: recordId,
                        ilsurl: ''
                    }));

                    //add MarcXML as HTML to data placeholder in libWB-tpl
                    if (recordId.toLowerCase().startsWith('tn_')) { //error if it is a PC record
                        $('#data').append(jQuery.PRIMO.template.renderById("remoteRecord-tpl", {}));
                    } else {
                        switch (record.control.sourceformat.toLowerCase()) {
                            case 'marc21':
                            case 'aleph':
                                $('#data').append(convertXML2HTML("#xml", '#pretty_marc'));
                                break;
                            case 'mab':
                                $('#data').append(convertXML2HTML("#xml", '#pretty_mab'));
                                break;
                        }

                    }
                });
            });
        } else {
            $('body').append(jQuery.PRIMO.template.renderById("noRecordID-tpl", {})); // error if no record id
        }
    </script>
</body>

</html>
